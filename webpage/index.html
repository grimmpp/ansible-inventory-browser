<!doctype html>
<html lang="en-US">
<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html">
  <title>Ansible Inventory Browser</title>
  <meta name="author" content="Philipp Grimm">

  <link rel="stylesheet" type="text/css" media="all" href="css/styles.css">
  <link rel="stylesheet" type="text/css" media="all" href="css/scrollableTable.css">
  
  <script type="text/javascript" src="js/jquery-3.4.1.min.js"></script>
  
  <!-- https://github.com/grimmpp/sortable-and-scrollable-table-with-fixed-header -->
  <script type="text/javascript" src="js/scrollableTable.js"></script>

  <!-- pre-generated data which originally comes from the inventories -->
  <script type="text/javascript" src="generated-data/data.js"></script>

  <script type="text/javascript" src="js/HistoryManager.js"></script>
</head>

<body>

    <div id="wrapper">
        <div id="buttonBar">
            <button id="btHosts">Hosts</button>
            <button id="btGroups">Groups</button>
            <button id="btAnalyse">Result of Analysis</button>
            <button id="btJSON">Show all Data as JSON</button>
            <input id="filterTextField" type="text" value="" 
                style="color: grey; padding-left: 8px; height: 26px; " onkeyup="filter()" 
                placeholder="type to filter table"
            ></span>
            <button id="Graph" onclick="location.href='graphView.html'">Jump to Graph View</button>
        </div>
        <pre id="detailView" ></pre>
    </div>

    <script type="text/javascript">
        
        var historyMgr = new HistoryManager({view: 'Hosts', filter: '', selectedObject: ''})

        var loggingEnabled = false
        var scrollableTable = new scrollableTable('scrollableTable', 'wrapper', loggingEnabled)
        scrollableTable.setTableHeight( () => { return $( window ).height() - 118 } )

        
        /** Generic function in order to fill table and tree view */
        function updateTable(tableConfig, data) {
            scrollableTable.setTableHeader(tableConfig['header'])
            scrollableTable.setTableContent(data, tableConfig['event-type'], tableConfig['columns'], tableConfig['subtreeProperty'])
            scrollableTable.expandTree()
        }

        /** generic function which shows the json object in #detailedView */
        function showJsonData(event, eventData) {
            if (eventData != null) {
                var tempObject = JSON.parse(JSON.stringify(eventData))
                delete tempObject.data.nodes
                $('#detailView').html( JSON.stringify( tempObject, null, 4) )
                historyMgr.setParameters({selectedObject: eventData.data.inventory+';'+eventData.data.type+';'+eventData.data.name })
            }
            else {
                $('#detailView').html("")
                historyMgr.setParameters({selectedObject: ''})
            }
        }

        /* button hosts onClick() => fill table with hosts */
        $('#btHosts').click( () => pushViewButton('Hosts', 'hosts', 'host-view') )

        /* event listener for 'selectedHost' => show JSON in host detailView */
        $( document ).on("selectedHost", showJsonData );

        /* button group onClick() => fill tree table with nested groups and hosts */
        $('#btGroups').click( () => pushViewButton('Groups', 'trees', 'group-view') )

        /* event listener for 'selectedGroup' => show JSON of group in detailView */
        $( document ).on("selectedGroup", showJsonData );

        /* button analyse onClick() => fill table with messages which were generated during parsing of the inventories. */
        $('#btAnalyse').click( () => pushViewButton('Analyse', 'messages', 'message-view') )

        /* event listener for 'selectedMessage' => show JSON of message in detailView */
        $( document ).on("selectedMessage", showJsonData );

        /* button JSON onClick() => show whole JSON data about everything which was parsed through all inventories */
        $('#btJSON').click( function() {
            refreshView('JSON')

            scrollableTable.clearTableContent()
            $('#detailView').html( JSON.stringify( data, null, 4) )
        })

        function refreshView(view) {
            // clean up when showing the view the first time
            if (historyMgr.getParameter('view') != view) {
                resetFilterTextField()
                historyMgr.setParameters({selectedObject: ''})
            }
            
            historyMgr.setParameters({view: view})
            $('#detailView').text("")
        }

        function pushViewButton(view, dataPart, configPart){
            refreshView(view)

            var tableConfig = data['ui-config'][configPart]
            updateTable(tableConfig, data[dataPart])
        }


        /* set history handler */

        /* after loading a page with url parameters it pushes a button in order to call a view */
        historyMgr.setHanlder('view', function(view){
            if (['Hosts', 'Groups', 'Analyse', 'JSON'].includes(view)) $('#bt'+view).trigger('click');
        })

        historyMgr.setHanlder('filter', function(value){
            $('#filterTextField').val(value)
            $('#filterTextField').trigger('keyup')
        })

        historyMgr.setHanlder('selectedObject', function(value){
            if (value != '') {
                var TR = $('#scrollableTable > tbody > tr[findStr="'+value+'"]')
                TR.click()
                TR.get(0).scrollIntoView({block: 'center', inline: 'center'})  // scroll to visible view
            }
        })

        /* end history handler */
        

        /* filter functions  */

        function filter() {
            var value = $('#filterTextField').val()
            scrollableTable.filter( value )
            historyMgr.setParameters({filter: value})
        }

        function resetFilterTextField() {
            $('#filterTextField').val('')
            historyMgr.setParameters({filter: ''})
        }

        /* end filter functions  */


        historyMgr.triggerPageByParameters()

    </script>
 
</body>
</html>